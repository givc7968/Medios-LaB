<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Guía de Preparación de Medios</title>
    
    <!-- PWA-specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Guía de Medios">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/007bff/FFFFFF/png?text=🧪&font=noto">
    <meta name="theme-color" id="theme-color-meta" content="#00428d">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --header-dark: #00428d;
            --main-bg-dark: #f0f4f8;
            --card-bg-dark: #ffffff;
            --accent-color: #f97316;
            --accent-color-hover: #ea580c;

            --header-light: #ffffff;
            --main-bg-light: #f9fafb;
            --card-bg-light: #ffffff;
        }

        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            flex-direction: column;
            background-color: var(--main-bg-dark); /* Changed to match main content */
            transition: background-color 0.3s ease;
        }
        body.light-mode { background-color: var(--main-bg-light); }
        #app-container { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        header.app-header {
            padding-top: env(safe-area-inset-top);
            flex-shrink: 0;
            background-image: linear-gradient(to bottom, #0052a8, #00428d);
            color: #ffffff;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.light-mode header.app-header {
             background-color: var(--header-light);
             color: #1f2937;
             border-bottom: 1px solid #e5e7eb;
             background-image: none;
        }
        #controls {
            flex-shrink: 0;
            background-color: var(--header-dark);
            transition: background-color 0.3s ease;
        }
        body.light-mode #controls { background-color: var(--header-light); }
        main {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
        }
        
        main footer {
            text-align: center;
            padding-top: 1rem;
            padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); /* Safe area for home bar */
            color: #6b7280;
            font-size: 0.75rem;
        }

        /* Visual Improvements */
        .content-card {
            background-color: var(--card-bg-dark);
            color: #1f2937;
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
        }
        body.light-mode .content-card { background-color: var(--card-bg-light); }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }

        .interactive-btn { transition: transform 0.1s ease; }
        .interactive-btn:active { transform: scale(0.95); }

        .table-cell { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        .table-header { background-color: #005cb8; color: white; font-weight: bold; }
        body.light-mode .table-header { background-color: #f3f4f6; color: #374151; }
        
        .checklist-item { display: flex; align-items: center; padding: 10px 4px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background-color 0.2s; }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-item:hover { background-color: #f9fafb; }
        .checklist-item .checkbox-custom {
            width: 22px; height: 22px; border: 2px solid #9ca3af; border-radius: 6px;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease-in-out; flex-shrink: 0;
        }
        .checklist-item .checkbox-custom .fa-check { transform: scale(0); transition: all 0.2s ease-in-out; color: white; font-size: 14px; }
        .checklist-item.completed .checkbox-custom { background-color: #22c55e; border-color: #22c55e; }
        .checklist-item.completed .checkbox-custom .fa-check { transform: scale(1); }
        .checklist-item.completed label { text-decoration: line-through; color: #6b7280; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .accent-btn { background-color: var(--accent-color); }
        .accent-btn:hover { background-color: var(--accent-color-hover); }
    </style>
</head>
<body>

    <div id="app-container">
        <header class="app-header p-4 shadow-lg z-10 flex justify-between items-center">
            <div class="w-10"></div>
            <h1 class="text-xl md:text-2xl font-bold text-center">Guía de Preparación de Medios</h1>
            <button id="theme-toggle-btn" class="interactive-btn text-xl p-2 rounded-full w-10 h-10 flex items-center justify-center">
                <i class="fas fa-sun"></i>
            </button>
        </header>

        <div id="controls" class="bg-[#00428d] p-4 pt-2">
             <div class="max-w-4xl mx-auto">
                <input type="search" id="search-box" placeholder="Buscar medio..." class="w-full p-3 mb-4 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#4da3ff] focus:border-[#4da3ff] text-lg">
                <select id="media-select" class="w-full p-3 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#4da3ff] focus:border-[#4da3ff] text-lg">
                </select>
            </div>
        </div>

        <main>
            <div id="procedure-display">
                <!-- Content cards will be injected here -->
            </div>
            <footer>
                <p>Manual de Procedimientos v2.0</p>
            </footer>
        </main>
    </div>
    
    <div id="calculator-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Calculadora de Volumen</h3>
            <div class="mb-4">
                <label for="volume-input" class="block text-sm font-medium text-gray-700">Volumen deseado (ml):</label>
                <input type="number" id="volume-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)] sm:text-sm" placeholder="Ej: 650">
            </div>
            <button id="calculate-btn" class="w-full accent-btn text-white font-bold py-2 px-4 rounded-lg transition-colors">Calcular</button>
            <div id="calculator-results" class="mt-4 text-gray-800"></div>
            <button id="close-modal-btn" class="w-full mt-4 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Cerrar</button>
        </div>
    </div>

    <script>
        const mediaDatabase = [
            {
                name: '7.1 Agar Tripticasa de Soya (TSA)',
                id: 'tsa',
                purpose: 'Medio de cultivo general para el aislamiento de una amplia variedad de microorganismos.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de Agar TSA', base_vol: 1000, base_qty: 40, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver el polvo en el agua para análisis. Aplicar calor suave si es necesario.',
                    'Verificar que el pH esté en el rango 7.2 - 7.4.',
                    'Esterilizar según el procedimiento estándar general (121°C por 15 min).',
                    'Enfriar a 45-50°C y dispensar en placas de Petri.'
                ]
            },
            {
                name: '7.2 Agar Tripticasa de Soya Sal (TSA/SAL)',
                id: 'tsa-sal',
                purpose: 'Medio para patógenos de ambiente salino.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de Agar TSA', base_vol: 1000, base_qty: 40, unit: 'g' },
                    { name: 'Cloruro de Sodio (NaCl)', base_vol: 1000, base_qty: 10, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver los polvos en el agua para análisis. Aplicar calor suave si es necesario.',
                    'Verificar pH en el rango 7.2 - 7.4.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y dispensar en placas de Petri.'
                ]
            },
            {
                name: '7.3 Agar TYES',
                id: 'tyes',
                purpose: 'Medio para el crecimiento de Flavobacterium psychrophilum.',
                storage: '2-8°C, hasta 90 días.',
                references: 'Holt, R. A. (1987).',
                notes: [],
                ingredients: [
                    { name: 'Triptona', base_vol: 1000, base_qty: 4.0, unit: 'g' },
                    { name: 'Extracto de levadura', base_vol: 1000, base_qty: 0.4, unit: 'g' },
                    { name: 'CaCl₂·2H₂O', base_vol: 1000, base_qty: 0.5, unit: 'g' },
                    { name: 'MgSO₄·7H₂O', base_vol: 1000, base_qty: 0.5, unit: 'g' },
                    { name: 'Agar', base_vol: 1000, base_qty: 15, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver los componentes en el agua para análisis con agitación y calor suave.',
                    'Verificar y ajustar pH a 7.2.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y dispensar en placas de Petri.'
                ]
            },
            {
                name: '7.4 Agar MAOA (Anacker y Ordal Modificado)',
                id: 'maoa',
                purpose: 'Medio para especies de Flavobacterium.',
                storage: '2-8°C, hasta 90 días.',
                references: 'Crump et al. (2001).',
                notes: [],
                ingredients: [
                    { name: 'Triptona', base_vol: 1000, base_qty: 5.0, unit: 'g' },
                    { name: 'Extracto de levadura', base_vol: 1000, base_qty: 0.5, unit: 'g' },
                    { name: 'Acetato de Sodio', base_vol: 1000, base_qty: 0.2, unit: 'g' },
                    { name: 'Extracto de carne', base_vol: 1000, base_qty: 0.2, unit: 'g' },
                    { name: 'Agar', base_vol: 1000, base_qty: 15, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver los componentes en el agua para análisis con agitación y calor suave.',
                    'Verificar y ajustar pH a 7.2 - 7.4.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y dispensar en placas de Petri.'
                ]
            },
            {
                name: '7.5 Agar Marino',
                id: 'agar-marino',
                purpose: 'Medio sólido para bacterias marinas heterótrofas.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de Agar Marino', base_vol: 1000, base_qty: 55.1, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver el polvo en el agua para análisis con agitación y calor suave.',
                    'Verificar que el pH esté en 7.6 ± 0.2.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y dispensar en placas.'
                ]
            },
            {
                name: '7.6 Caldo Marino (Marine Broth 2216)',
                id: 'caldo-marino',
                purpose: 'Medio líquido para el cultivo de bacterias marinas heterótrofas.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de Caldo Marino', base_vol: 1000, base_qty: 37.4, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Suspender el polvo en el agua para análisis.',
                    'Calentar con agitación frecuente y hervir durante 1 minuto para disolver.',
                    'Verificar que el pH final esté en el rango 7.6 ± 0.2.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar y alicuotar si es necesario.'
                ]
            },
            {
                name: '7.7 Agar Sabouraud Dextrosa',
                id: 'sabouraud',
                purpose: 'Medio para aislamiento de hongos y levaduras.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de Agar Sabouraud', base_vol: 1000, base_qty: 65, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver el polvo en el agua para análisis con agitación y calor suave.',
                    'Verificar y ajustar pH a 5.6 ± 0.2.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y dispensar en placas.'
                ]
            },
            {
                name: '7.8 Agar Papa Dextrosa (PDA)',
                id: 'pda',
                purpose: 'Medio para cultivo de levaduras y mohos.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: ['Para inhibir el crecimiento bacteriano, el medio estéril y enfriado (45-50°C) puede ser acidificado con ácido tartárico estéril al 10%. No recalentar el medio tras la adición del ácido.'],
                ingredients: [
                    { name: 'Polvo de PDA (Difco)', base_vol: 1000, base_qty: 39, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Suspender el polvo en el agua.',
                    'Calentar con agitación y hervir por 1 minuto para disolver.',
                    'Verificar que el pH esté en 5.6 ± 0.2.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y dispensar en placas.'
                ]
            },
            {
                name: '7.9 Agar P. salmonis',
                id: 'agar-p-salmonis',
                purpose: 'Medio adecuado para el crecimiento de Piscirickettsia salmonis.',
                storage: '2-8°C, hasta 30 días.',
                references: null,
                notes: ['La cantidad de NaOH es una estimación, siempre verificar con medidor de pH.', 'La sangre es termolábil. Añadir al medio base enfriado.'],
                ingredients: [
                    { name: 'Agar Base Sangre', base_vol: 1000, base_qty: 40, unit: 'g' },
                    { name: 'NaCl', base_vol: 1000, base_qty: 5, unit: 'g' },
                    { name: 'L-Cisteína', base_vol: 1000, base_qty: 1, unit: 'g' },
                    { name: 'NaOH 10N', base_vol: 1000, base_qty: 200, unit: 'µL' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 960, unit: 'ml' },
                    { name: 'Sangre desfibrinada', base_vol: 1000, base_qty: 40, unit: 'ml' }
                ],
                steps: [
                    'Disolver los polvos en 960 ml de agua para análisis. Aplicar calor suave si es necesario.',
                    'Añadir el NaOH estimado y verificar con pHmetro hasta alcanzar 6.7 ± 0.1.',
                    'Esterilizar el medio base según el procedimiento estándar general.',
                    'Enfriar a 80°C y añadir asépticamente los 40 ml de sangre.',
                    'Mezclar suavemente y dispensar en placas.'
                ]
            },
            {
                name: '7.10 Agar KDM-C (con Carbón)',
                id: 'kdm-c',
                purpose: 'Medio selectivo para Renibacterium salmoninarum.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: ['El carbón activado puede dificultar la lectura de las colonias. Asegurar una buena iluminación al examinar las placas.'],
                ingredients: [
                    { name: 'Peptona', base_vol: 1000, base_qty: 10, unit: 'g' },
                    { name: 'Extracto de levadura', base_vol: 1000, base_qty: 0.5, unit: 'g' },
                    { name: 'Carbón activado', base_vol: 1000, base_qty: 1, unit: 'g' },
                    { name: 'L-cisteína', base_vol: 1000, base_qty: 1, unit: 'g' },
                    { name: 'NaOH 10N', base_vol: 1000, base_qty: 600, unit: 'µL' },
                    { name: 'Agar', base_vol: 1000, base_qty: 15, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' },
                    { name: 'Amphotericin B', base_vol: 1000, base_qty: 1, unit: 'ml' }
                ],
                steps: [
                    'Disolver los componentes (excepto Amphotericin B) en agua para análisis con agitación y calor.',
                    'Añadir el NaOH 10N y verificar que el pH final esté en el rango 7.2 - 7.4.',
                    'Esterilizar el medio base según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y añadir la Amphotericin B asépticamente.',
                    'Mezclar y dispensar en placas.'
                ]
            },
            {
                name: '7.11 Agar KDM-2 (con Suero)',
                id: 'kdm2-agar',
                purpose: 'Medio enriquecido para Renibacterium salmoninarum.',
                storage: '2-8°C, hasta 30 días.',
                references: null,
                notes: ['El ajuste de pH a 7.5 ± 0.1 es un paso CRÍTICO para el crecimiento de R. salmoninarum.', 'El Suero Fetal Bovino es termolábil. No añadir a medios calientes.'],
                ingredients: [
                    { name: 'Peptona', base_vol: 1000, base_qty: 10, unit: 'g' },
                    { name: 'Extracto de levadura', base_vol: 1000, base_qty: 0.5, unit: 'g' },
                    { name: 'L-Cisteína', base_vol: 1000, base_qty: 1, unit: 'g' },
                    { name: 'NaOH 10N (estimado)', base_vol: 1000, base_qty: 424, unit: 'µL' },
                    { name: 'Agar', base_vol: 1000, base_qty: 15, unit: 'g' },
                    { name: 'Agua para análisis (base)', base_vol: 1000, base_qty: 900, unit: 'ml' },
                    { name: 'Suero Fetal Bovino', base_vol: 1000, base_qty: 100, unit: 'ml' }
                ],
                steps: [
                    'Disolver los componentes (excepto SFB) en 900 ml de agua para análisis con agitación y calor.',
                    'Añadir lentamente la cantidad estimada de NaOH 10N y verificar con un medidor de pH hasta alcanzar un pH de 7.5 ± 0.1.',
                    'Esterilizar el medio base según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y añadir los 100 ml de Suero Fetal Bovino asépticamente.',
                    'Mezclar y dispensar en placas.'
                ]
            },
            {
                name: '7.12 Caldo KDM-2 Líquido',
                id: 'kdm2-broth',
                purpose: 'Medio líquido para el cultivo de R. salmoninarum.',
                storage: '2-8°C, hasta 30 días.',
                references: 'Evelyn (1977), Rhodes et al. (2008).',
                notes: ['El ajuste de pH a 7.5 ± 0.1 es un paso CRÍTICO. El pH inicial es aprox. 5.15, por lo que el ajuste debe ser cuidadoso.', 'Las cantidades de NaOH 10N son estimaciones. Siempre verificar con medidor calibrado.', 'El Suero Fetal Bovino es termolábil. No añadir a medios calientes.'],
                ingredients: [
                    { name: 'Peptona', base_vol: 1000, base_qty: 10, unit: 'g' },
                    { name: 'Extracto de levadura', base_vol: 1000, base_qty: 0.5, unit: 'g' },
                    { name: 'L-Cisteína HCl', base_vol: 1000, base_qty: 0.5, unit: 'g' },
                    { name: 'NaOH 10N (estimado)', base_vol: 1000, base_qty: 424, unit: 'µL' },
                    { name: 'Agua para análisis (base)', base_vol: 1000, base_qty: 900, unit: 'ml' },
                    { name: 'Suero Fetal Bovino', base_vol: 1000, base_qty: 100, unit: 'ml' }
                ],
                steps: [
                    'Disolver los polvos en 900 ml de agua para análisis.',
                    'Ajuste de pH (Paso Crítico): Medir pH inicial (aprox. 5.15). Añadir lentamente el NaOH 10N estimado y ajustar gota a gota hasta alcanzar 7.5 ± 0.1.',
                    'Esterilizar el medio base según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y añadir los 100 ml de Suero Fetal Bovino asépticamente.',
                    'Mezclar y alicuotar si es necesario.'
                ]
            },
            {
                name: '7.13 Caldo IFOP PsM11',
                id: 'ifop-psm11',
                purpose: 'Medio líquido para determinar la CIM de P. salmonis.',
                storage: '4°C, máx. 10 días.',
                references: 'Contreras-Lynch et al. (2017).',
                notes: ['La Solución Stock se debe esterilizar por filtración, NUNCA en autoclave, ya que sus componentes son termolábiles.'],
                ingredients: [
                    { name: 'TSB', base_vol: 1000, base_qty: 25, unit: 'g' },
                    { name: 'NaCl', base_vol: 1000, base_qty: 15, unit: 'g' },
                    { name: 'Agua para análisis (base)', base_vol: 1000, base_qty: 900, unit: 'ml' },
                    { name: 'Solución Stock', base_vol: 1000, base_qty: 50, unit: 'ml' },
                    { name: 'Suero Fetal Bovino', base_vol: 1000, base_qty: 50, unit: 'ml' }
                ],
                steps: [
                    'Disolver TSB y NaCl en 900 ml de agua para análisis.',
                    'Esterilizar el medio base según el procedimiento estándar general.',
                    'Enfriar a 45-50°C, añadir la Solución Stock y el SFB asépticamente.',
                    'Mezclar y alicuotar.'
                ]
            },
            {
                name: '7.14 Suero Fisiológico (Solución Salina 0.9%)',
                id: 'suero-fisiologico',
                purpose: 'Solución salina isotónica para diluciones.',
                storage: 'Temp. ambiente, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Cloruro de Sodio (NaCl)', base_vol: 1000, base_qty: 9, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver el NaCl en el agua para análisis.',
                    'Dispensar en recipientes finales.',
                    'Esterilizar según el procedimiento estándar general.'
                ]
            },
            {
                name: '7.15 Caldo Tripticasa de Soya (TSB)',
                id: 'tsb-broth',
                purpose: 'Medio líquido de enriquecimiento general.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de TSB', base_vol: 1000, base_qty: 30, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver el polvo en el agua para análisis.',
                    'Verificar pH en 7.2 - 7.4.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar y alicuotar.'
                ]
            },
            {
                name: '7.16 Caldo Tripticasa de Soya Sal (TSB/SAL)',
                id: 'tsb-sal-broth',
                purpose: 'Medio líquido para microorganismos halófilos.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de TSB', base_vol: 1000, base_qty: 30, unit: 'g' },
                    { name: 'Cloruro de Sodio (NaCl)', base_vol: 1000, base_qty: 10, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver ambos polvos en el agua para análisis.',
                    'Verificar pH en 7.2 - 7.4.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar y alicuotar.'
                ]
            },
            {
                name: '7.17 Caldo Mueller Hinton II Ajustado con Cationes (MHCA)',
                id: 'mhca',
                purpose: 'Medio estándar para pruebas de sensibilidad.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de Caldo MHCA', base_vol: 1000, base_qty: 22, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver el polvo en el agua para análisis.',
                    'Calentar y hervir por 1 minuto.',
                    'Verificar pH en 7.3 ± 0.1.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar y alicuotar.'
                ]
            },
            {
                name: '7.18 Caldo Mueller-Hinton Diluido (1:7) Suplementado con Iones Inorgánicos',
                id: 'mh-diluted',
                purpose: 'Medio líquido diluido para pruebas de CMI en Tenacibaculum.',
                storage: '2-8°C, protegido de la luz.',
                references: 'CLSI VET04-A2 (2014).',
                notes: [],
                ingredients: [
                    { name: 'Caldo MH en polvo', base_vol: 1000, base_qty: 3.0, unit: 'g' },
                    { name: 'NaCl', base_vol: 1000, base_qty: 21.43, unit: 'g' },
                    { name: 'MgSO₄·7H₂O', base_vol: 1000, base_qty: 4.29, unit: 'g' },
                    { name: 'CaCl₂·2H₂O', base_vol: 1000, base_qty: 0.86, unit: 'g' },
                    { name: 'KCl', base_vol: 1000, base_qty: 0.86, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver todos los componentes sólidos directamente en el 80% del volumen final de agua.',
                    'Transferir a un matraz aforado y completar el volumen final con agua. Homogeneizar.',
                    'Verificar que el pH esté en el rango 7.2 - 7.4.',
                    'Esterilizar en autoclave según el procedimiento estándar general.',
                    'Enfriar y alicuotar en recipientes estériles si es necesario.'
                ]
            },
            {
                name: '7.19 Caldo Mueller Hinton Cationes Ajustados Diluido (4g/L)',
                id: 'mhca-diluted',
                purpose: 'Medio líquido diluido para pruebas de CMI en Flavobacterium.',
                storage: '2-8°C, hasta 4 semanas.',
                references: 'CLSI VET04-A2 (2014).',
                notes: [],
                ingredients: [
                    { name: 'CAMHB en polvo', base_vol: 1000, base_qty: 4.0, unit: 'g' },
                    { name: 'Agua Purificada', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver los componentes en el agua para análisis con agitación y calor suave.',
                    'Verificar que el pH esté en el rango 7.2 - 7.4. Generalmente no se requiere ajuste.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a temperatura ambiente y dispensar asépticamente.'
                ]
            },
            {
                name: '8.1 Solución Stock (L-Cisteína/D-Glucosa)',
                id: 'solucion-stock-ifop',
                purpose: 'Suplemento estéril para Caldo IFOP PsM11.',
                storage: '2-8°C.',
                references: null,
                notes: ['Esta solución DEBE ser esterilizada por filtración (membrana de 0.22 µm). NUNCA autoclavar.', 'Realizar todo el procedimiento bajo Campana de Flujo Laminar.'],
                ingredients: [
                    { name: 'L-Cisteína HCl', base_vol: 500, base_qty: 10, unit: 'g' },
                    { name: 'D-Glucosa', base_vol: 500, base_qty: 100, unit: 'g' },
                    { name: 'Agua para análisis estéril', base_vol: 500, base_qty: 500, unit: 'ml' }
                ],
                steps: [
                    'Pesar y añadir los solutos a una botella estéril.',
                    'Aforar a 500 ml con agua para análisis estéril.',
                    'Agitar suavemente hasta disolver.',
                    'Esterilizar por filtración.',
                    'Dispensar en alícuotas estériles.'
                ]
            }
        ];
        
        const selectElement = document.getElementById('media-select');
        const searchBox = document.getElementById('search-box');
        const displayElement = document.getElementById('procedure-display');
        const modal = document.getElementById('calculator-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const calculateBtn = document.getElementById('calculate-btn');
        const volumeInput = document.getElementById('volume-input');
        const calculatorResults = document.getElementById('calculator-results');
        const themeToggleButton = document.getElementById('theme-toggle-btn');
        const themeColorMeta = document.getElementById('theme-color-meta');

        let currentMediaForCalculator = null;

        function populateSelect(filter = '') {
            const filteredMedia = mediaDatabase.filter(media => media.name.toLowerCase().includes(filter.toLowerCase()));
            const currentSelection = selectElement.value;
            selectElement.innerHTML = '';
            
            if (!filter) {
                const placeholder = document.createElement('option');
                placeholder.value = "";
                placeholder.textContent = "-- Seleccione un procedimiento --";
                placeholder.disabled = true;
                placeholder.selected = true;
                selectElement.appendChild(placeholder);
            }

            filteredMedia.sort((a, b) => a.name.localeCompare(b.name));
            filteredMedia.forEach(media => {
                const option = document.createElement('option');
                option.value = media.id;
                option.textContent = media.name;
                selectElement.appendChild(option);
            });

            if (filteredMedia.find(m => m.id === currentSelection)) {
                selectElement.value = currentSelection;
            } else if (filteredMedia.length > 0) {
                renderProcedure(filteredMedia[0].id);
                selectElement.value = filteredMedia[0].id;
            } else {
                 displayElement.innerHTML = '<div class="content-card text-center text-gray-500"><p>No se encontraron medios.</p></div>';
            }
        }
        
        function formatNumber(num) {
            return Number.isInteger(num) ? num : parseFloat(num.toFixed(3));
        }

        function renderProcedure(mediaId) {
            displayElement.classList.remove('fade-in');

            setTimeout(() => {
                const media = mediaDatabase.find(m => m.id === mediaId);
                currentMediaForCalculator = media;
                if (!media) {
                     displayElement.innerHTML = `
                        <div class="content-card text-center p-8">
                            <h2 class="text-2xl font-bold text-[#00428d] mb-4">Bienvenido a la Guía de Medios</h2>
                            <p class="text-gray-600">Seleccione un procedimiento del menú superior para comenzar.</p>
                            <i class="fas fa-flask-vial text-6xl text-gray-300 mt-6"></i>
                        </div>
                     `;
                     displayElement.classList.add('fade-in');
                    return;
                }

                const createCard = (title, content, iconClass) => {
                    if (!content || content.trim() === '') return '';
                    return `
                        <div class="content-card">
                            <h3 class="text-xl font-bold mb-3 text-[#005cb8] flex items-center">
                                <i class="fa-solid ${iconClass} w-6 text-center mr-3 text-lg"></i>
                                ${title}
                            </h3>
                            ${content}
                        </div>
                    `;
                };

                const ingredientsTable = `
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse my-2 text-sm md:text-base">
                            <thead>
                                <tr>
                                    <th class="table-cell table-header">Componente</th>
                                    <th class="table-cell table-header text-right">Para 1000 ml</th>
                                    <th class="table-cell table-header text-right">Para 500 ml</th>
                                    <th class="table-cell table-header text-right">Para 250 ml</th>
                                </tr>
                            </thead>
                            <tbody>
                ${media.ingredients.map(ing => {
                    const getAmountForVolume = (targetVol) => {
                        // Special case for stock solution which is only defined for 500ml
                        if (media.id === 'solucion-stock-ifop' && ing.base_vol !== targetVol) {
                            return 'N/A';
                        }
                        const amount = (targetVol / ing.base_vol) * ing.base_qty;
                        return `${formatNumber(amount)} ${ing.unit}`;
                    };
                    return `
                        <tr>
                            <td class="table-cell font-semibold">${ing.name}</td>
                            <td class="table-cell text-right">${getAmountForVolume(1000)}</td>
                            <td class="table-cell text-right">${getAmountForVolume(500)}</td>
                            <td class="table-cell text-right">${getAmountForVolume(250)}</td>
                        </tr>
                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>`;

                const stepsList = `<ol class="space-y-1 mt-2">${media.steps.map((step, index) => `
                    <li class="checklist-item" data-step="${index}">
                        <span class="checkbox-custom"><i class="fa-solid fa-check"></i></span>
                        <label class="text-gray-700 leading-relaxed">${step}</label>
                    </li>`).join('')}</ol>`;
                
                const notesList = (media.notes && media.notes.length > 0) 
                    ? `<ul class="list-disc list-inside space-y-1 mt-2">${media.notes.map(note => `<li>${note}</li>`).join('')}</ul>`
                    : '';
                
                const referencesHTML = media.references ? `<p class="text-sm text-gray-600 italic mt-2">${media.references}</p>` : '';

                const procedureHTML = `
                    <div class="content-card">
                        <div class="flex justify-between items-start">
                             <h2 class="text-2xl md:text-3xl font-bold text-[#00428d]">${media.name}</h2>
                             <button id="open-calculator-btn" class="interactive-btn text-white accent-btn rounded-full w-12 h-12 flex items-center justify-center text-2xl shadow-lg"><i class="fa-solid fa-calculator"></i></button>
                        </div>
                        <p class="text-gray-600 mt-2 mb-4">${media.purpose}</p>
                    </div>
                    ${createCard('Ingredientes y Cantidades', ingredientsTable, 'fa-vials')}
                    ${createCard('Procedimiento', stepsList, 'fa-list-check')}
                    ${createCard('Consideraciones Importantes', notesList, 'fa-triangle-exclamation')}
                    ${createCard('Almacenamiento y Vida Útil', `<p>${media.storage}</p>`, 'fa-box-archive')}
                    ${createCard('Referencias', referencesHTML, 'fa-book-bookmark')}
                `;

                displayElement.innerHTML = procedureHTML;
                displayElement.classList.add('fade-in');

                document.getElementById('open-calculator-btn').addEventListener('click', openCalculator);
                
                document.querySelectorAll('.checklist-item').forEach(item => {
                    item.addEventListener('click', () => {
                        item.classList.toggle('completed');
                    });
                });
            }, 50);
        }
        
        function openCalculator() {
            volumeInput.value = '';
            calculatorResults.innerHTML = '';
            modal.classList.remove('hidden');
        }

        function closeCalculator() {
            modal.classList.add('hidden');
        }

        calculateBtn.addEventListener('click', () => {
            const targetVolume = parseFloat(volumeInput.value);
            if (!targetVolume || targetVolume <= 0 || !currentMediaForCalculator) {
                calculatorResults.innerHTML = '<p class="text-red-500">Por favor, ingrese un volumen válido.</p>';
                return;
            }

            let resultsHTML = `<h4 class="font-bold mt-4 mb-2">Resultados para ${targetVolume} ml:</h4><ul class="list-disc list-inside space-y-1">`;
            currentMediaForCalculator.ingredients.forEach(ing => {
                const newQty = (targetVolume / (ing.base_vol || 1000)) * ing.base_qty;
                resultsHTML += `<li><strong>${ing.name}:</strong> ${formatNumber(newQty)} ${ing.unit}</li>`;
            });
            resultsHTML += '</ul>';
            calculatorResults.innerHTML = resultsHTML;
        });
        
        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                themeToggleButton.innerHTML = '<i class="fas fa-moon"></i>';
                themeColorMeta.setAttribute('content', '#ffffff');
            } else {
                document.body.classList.remove('light-mode');
                themeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
                themeColorMeta.setAttribute('content', '#00428d');
            }
        }

        themeToggleButton.addEventListener('click', () => {
            const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        searchBox.addEventListener('input', (e) => populateSelect(e.target.value));
        selectElement.addEventListener('change', (e) => renderProcedure(e.target.value));
        closeModalBtn.addEventListener('click', closeCalculator);
        modal.addEventListener('click', (e) => { if(e.target === modal) closeCalculator(); });
        
        document.addEventListener('DOMContentLoaded', () => {
            populateSelect();
            renderProcedure(null);
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
        });

    </script>
</body>
</html>
