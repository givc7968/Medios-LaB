<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Guía de Preparación de Medios</title>
    
    <!-- PWA-specific meta tags for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Guía de Medios">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='22' fill='%23007bff'/%3e%3cpath fill='white' d='M60,15H40V35H25L35,85H65L75,35H60V15ZM55,35H45V20H55V35Z'/%3e%3c/svg%3e">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            flex-direction: column;
        }
        #app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        header.app-header {
            padding-top: env(safe-area-inset-top);
            flex-shrink: 0;
        }
        #controls {
            flex-shrink: 0;
        }
        main {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        footer {
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .table-cell {
            border: 1px solid #005cb8;
            padding: 8px;
            text-align: left;
        }
        .table-header {
            background-color: #005cb8;
            color: white;
            font-weight: bold;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
        }
        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 15px;
        }
        .checklist-item.completed label {
            text-decoration: line-through;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-[#00428d]">

    <div id="app-container">
        <header class="app-header bg-[#00428d] text-white p-4 shadow-lg z-10">
            <h1 class="text-2xl font-bold text-center">Guía de Preparación de Medios</h1>
        </header>

        <div id="controls" class="bg-[#00428d] p-4 pt-2">
             <div class="max-w-4xl mx-auto">
                <input type="search" id="search-box" placeholder="Buscar medio..." class="w-full p-3 mb-4 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#4da3ff] focus:border-[#4da3ff] text-lg">
                <select id="media-select" class="w-full p-3 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#4da3ff] focus:border-[#4da3ff] text-lg">
                </select>
            </div>
        </div>

        <main class="bg-slate-100">
            <div class="max-w-4xl mx-auto p-4 md:p-6">
                <div id="procedure-display" class="bg-white rounded-xl shadow-inner p-4 md:p-6">
                </div>
            </div>
        </main>

        <footer class="text-center p-4 bg-[#00428d]">
            <p class="text-sm text-sky-300">Aplicación generada a partir del Manual de Procedimientos v2.0</p>
        </footer>
    </div>
    
    <div id="calculator-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Calculadora de Volumen</h3>
            <div class="mb-4">
                <label for="volume-input" class="block text-sm font-medium text-gray-700">Volumen deseado (ml):</label>
                <input type="number" id="volume-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ej: 650">
            </div>
            <button id="calculate-btn" class="w-full bg-[#007bff] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#005cb8]">Calcular</button>
            <div id="calculator-results" class="mt-4"></div>
            <button id="close-modal-btn" class="w-full mt-4 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Cerrar</button>
        </div>
    </div>

    <script>
        const mediaDatabase = [
             {
                name: 'Agar Tripticasa de Soya (TSA)',
                id: 'tsa',
                purpose: 'Medio de cultivo general para el aislamiento de una amplia variedad de microorganismos.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de Agar TSA', base_vol: 1000, base_qty: 40, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver el polvo en el agua para análisis. Aplicar calor suave si es necesario.',
                    'Verificar que el pH esté en el rango 7.2 - 7.4.',
                    'Esterilizar según el procedimiento estándar general (121°C por 15 min).',
                    'Enfriar a 45-50°C y dispensar en placas de Petri.'
                ]
            },
            {
                name: 'Agar Tripticasa de Soya Sal (TSA/SAL)',
                id: 'tsa-sal',
                purpose: 'Medio para patógenos de ambiente salino.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de Agar TSA', base_vol: 1000, base_qty: 40, unit: 'g' },
                    { name: 'Cloruro de Sodio (NaCl)', base_vol: 1000, base_qty: 10, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver los polvos en el agua para análisis. Aplicar calor suave si es necesario.',
                    'Verificar pH en el rango 7.2 - 7.4.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y dispensar en placas de Petri.'
                ]
            },
            {
                name: 'Agar TYES',
                id: 'tyes',
                purpose: 'Medio para el crecimiento de Flavobacterium psychrophilum.',
                storage: '2-8°C, hasta 90 días.',
                references: 'Holt, R. A. (1987).',
                notes: [],
                ingredients: [
                    { name: 'Triptona', base_vol: 1000, base_qty: 4.0, unit: 'g' },
                    { name: 'Extracto de levadura', base_vol: 1000, base_qty: 0.4, unit: 'g' },
                    { name: 'CaCl₂·2H₂O', base_vol: 1000, base_qty: 0.5, unit: 'g' },
                    { name: 'MgSO₄·7H₂O', base_vol: 1000, base_qty: 0.5, unit: 'g' },
                    { name: 'Agar', base_vol: 1000, base_qty: 15, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver los componentes en el agua para análisis con agitación y calor suave.',
                    'Verificar y ajustar pH a 7.2.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y dispensar en placas de Petri.'
                ]
            },
            {
                name: 'Agar MAOA (Anacker y Ordal Modificado)',
                id: 'maoa',
                purpose: 'Medio para especies de Flavobacterium.',
                storage: '2-8°C, hasta 90 días.',
                references: 'Crump et al. (2001).',
                notes: [],
                ingredients: [
                    { name: 'Triptona', base_vol: 1000, base_qty: 5.0, unit: 'g' },
                    { name: 'Extracto de levadura', base_vol: 1000, base_qty: 0.5, unit: 'g' },
                    { name: 'Acetato de Sodio', base_vol: 1000, base_qty: 0.2, unit: 'g' },
                    { name: 'Extracto de carne', base_vol: 1000, base_qty: 0.2, unit: 'g' },
                    { name: 'Agar', base_vol: 1000, base_qty: 15, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver los componentes en el agua para análisis con agitación y calor suave.',
                    'Verificar y ajustar pH a 7.2 - 7.4.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y dispensar en placas de Petri.'
                ]
            },
            {
                name: 'Agar Marino',
                id: 'agar-marino',
                purpose: 'Medio sólido para bacterias marinas heterótrofas.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de Agar Marino', base_vol: 1000, base_qty: 55.1, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver el polvo en el agua para análisis con agitación y calor suave.',
                    'Verificar que el pH esté en 7.6 ± 0.2.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y dispensar en placas.'
                ]
            },
            {
                name: 'Caldo Marino (Marine Broth 2216)',
                id: 'caldo-marino',
                purpose: 'Medio líquido para el cultivo de bacterias marinas heterótrofas.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de Caldo Marino', base_vol: 1000, base_qty: 37.4, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Suspender el polvo en el agua para análisis.',
                    'Calentar con agitación frecuente y hervir durante 1 minuto para disolver.',
                    'Verificar que el pH final esté en el rango 7.6 ± 0.2.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar y alicuotar si es necesario.'
                ]
            },
            {
                name: 'Agar Sabouraud Dextrosa',
                id: 'sabouraud',
                purpose: 'Medio para aislamiento de hongos y levaduras.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de Agar Sabouraud', base_vol: 1000, base_qty: 65, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver el polvo en el agua para análisis con agitación y calor suave.',
                    'Verificar y ajustar pH a 5.6 ± 0.2.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y dispensar en placas.'
                ]
            },
            {
                name: 'Agar Papa Dextrosa (PDA)',
                id: 'pda',
                purpose: 'Medio para cultivo de levaduras y mohos.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: ['Para inhibir el crecimiento bacteriano, el medio estéril y enfriado (45-50°C) puede ser acidificado con ácido tartárico estéril al 10%. No recalentar el medio tras la adición del ácido.'],
                ingredients: [
                    { name: 'Polvo de PDA (Difco)', base_vol: 1000, base_qty: 39, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Suspender el polvo en el agua.',
                    'Calentar con agitación y hervir por 1 minuto para disolver.',
                    'Verificar que el pH esté en 5.6 ± 0.2.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y dispensar en placas.'
                ]
            },
            {
                name: 'Agar P. salmonis',
                id: 'p-salmonis',
                purpose: 'Medio enriquecido para Piscirickettsia salmonis.',
                storage: '2-8°C, hasta 30 días.',
                references: null,
                notes: ['La adición de sangre debe ser aséptica y a la temperatura correcta (45-50°C) para no lisar los glóbulos rojos.'],
                ingredients: [
                    { name: 'Agar Base Sangre', base_vol: 960, base_qty: 40, unit: 'g' },
                    { name: 'Cloruro de Sodio', base_vol: 960, base_qty: 5, unit: 'g' },
                    { name: 'L-Cisteína', base_vol: 960, base_qty: 1, unit: 'g' },
                    { name: 'NaOH 10N (estimado)', base_vol: 960, base_qty: 200, unit: 'µL' },
                    { name: 'Agua para análisis', base_vol: 960, base_qty: 960, unit: 'ml' },
                    { name: 'Sangre desfibrinada', base_vol: 960, base_qty: 40, unit: 'ml' }
                ],
                steps: [
                    'Disolver los polvos en el agua para análisis con agitación y calor.',
                    'Añadir lentamente la cantidad estimada de NaOH 10N y verificar con un medidor de pH hasta alcanzar un pH final de 6.7 ± 0.1. Nota: La cantidad de NaOH es una estimación y puede variar.',
                    'Esterilizar el medio base según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y añadir la sangre asépticamente.',
                    'Mezclar suavemente y dispensar en placas.'
                ]
            },
            {
                name: 'Agar KDM-C (con Carbón)',
                id: 'kdm-c',
                purpose: 'Medio selectivo para Renibacterium salmoninarum.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: ['El carbón activado puede dificultar la lectura de las colonias. Asegurar una buena iluminación al examinar las placas.'],
                ingredients: [
                    { name: 'Peptona', base_vol: 1000, base_qty: 10, unit: 'g' },
                    { name: 'Extracto de levadura', base_vol: 1000, base_qty: 0.5, unit: 'g' },
                    { name: 'Carbón activado', base_vol: 1000, base_qty: 1, unit: 'g' },
                    { name: 'L-cisteína', base_vol: 1000, base_qty: 1, unit: 'g' },
                    { name: 'NaOH 10N', base_vol: 1000, base_qty: 600, unit: 'µL' },
                    { name: 'Agar', base_vol: 1000, base_qty: 15, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' },
                    { name: 'Amphotericin B', base_vol: 1000, base_qty: 1, unit: 'ml' }
                ],
                steps: [
                    'Disolver los componentes (excepto Amphotericin B) en agua para análisis con agitación y calor.',
                    'Añadir el NaOH 10N y verificar que el pH final esté en el rango 7.2 - 7.4.',
                    'Esterilizar el medio base según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y añadir la Amphotericin B asépticamente.',
                    'Mezclar y dispensar en placas.'
                ]
            },
            {
                name: 'Agar KDM-2 (con Suero)',
                id: 'kdm2-agar',
                purpose: 'Medio enriquecido para Renibacterium salmoninarum.',
                storage: '2-8°C, hasta 30 días.',
                references: null,
                notes: ['El ajuste de pH a 7.5 ± 0.1 es un paso CRÍTICO para el crecimiento de R. salmoninarum.', 'El Suero Fetal Bovino es termolábil. No añadir a medios calientes.'],
                ingredients: [
                    { name: 'Peptona', base_vol: 900, base_qty: 10, unit: 'g' },
                    { name: 'Extracto de levadura', base_vol: 900, base_qty: 0.5, unit: 'g' },
                    { name: 'L-Cisteína', base_vol: 900, base_qty: 1, unit: 'g' },
                    { name: 'NaOH 10N (estimado)', base_vol: 900, base_qty: 424, unit: 'µL' },
                    { name: 'Agar', base_vol: 900, base_qty: 15, unit: 'g' },
                    { name: 'Agua para análisis (base)', base_vol: 900, base_qty: 900, unit: 'ml' },
                    { name: 'Suero Fetal Bovino', base_vol: 900, base_qty: 100, unit: 'ml' }
                ],
                steps: [
                    'Disolver los componentes (excepto SFB) en agua para análisis con agitación y calor.',
                    'Añadir lentamente la cantidad estimada de NaOH 10N y verificar con un medidor de pH hasta alcanzar un pH de 7.5 ± 0.1. Nota: Las cantidades son estimaciones y pueden variar.',
                    'Esterilizar el medio base según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y añadir el Suero Fetal Bovino asépticamente.',
                    'Mezclar y dispensar en placas.'
                ]
            },
            {
                name: 'Caldo KDM-2 Líquido',
                id: 'kdm2-broth',
                purpose: 'Medio líquido para el cultivo de R. salmoninarum.',
                storage: '2-8°C, hasta 30 días.',
                references: 'Evelyn (1977), Rhodes et al. (2008).',
                notes: ['El ajuste de pH a 7.5 ± 0.1 es un paso CRÍTICO. El pH inicial es aprox. 5.15, por lo que el ajuste debe ser cuidadoso.', 'Las cantidades de NaOH 10N son estimaciones. Siempre verificar con medidor calibrado.', 'El Suero Fetal Bovino es termolábil. No añadir a medios calientes.'],
                ingredients: [
                    { name: 'Peptona', base_vol: 900, base_qty: 10, unit: 'g' },
                    { name: 'Extracto de levadura', base_vol: 900, base_qty: 0.5, unit: 'g' },
                    { name: 'L-Cisteína HCl', base_vol: 900, base_qty: 0.5, unit: 'g' },
                    { name: 'NaOH 10N (estimado)', base_vol: 900, base_qty: 424, unit: 'µL' },
                    { name: 'Agua para análisis (base)', base_vol: 900, base_qty: 900, unit: 'ml' },
                    { name: 'Suero Fetal Bovino', base_vol: 900, base_qty: 100, unit: 'ml' }
                ],
                steps: [
                    'Disolver los polvos en el agua para análisis.',
                    'Ajuste de pH (Paso Crítico): Medir pH inicial (aprox. 5.15). Añadir lentamente el NaOH 10N estimado y ajustar gota a gota hasta alcanzar 7.5 ± 0.1.',
                    'Esterilizar el medio base según el procedimiento estándar general.',
                    'Enfriar a 45-50°C y añadir el Suero Fetal Bovino asépticamente.',
                    'Mezclar y alicuotar si es necesario.'
                ]
            },
            {
                name: 'Caldo IFOP PsM11',
                id: 'ifop-psm11',
                purpose: 'Medio líquido para determinar la CIM de P. salmonis.',
                storage: '4°C, máx. 10 días.',
                references: 'Contreras-Lynch et al. (2017).',
                notes: ['La Solución Stock se debe esterilizar por filtración, NUNCA en autoclave, ya que sus componentes son termolábiles.'],
                ingredients: [
                    { name: 'TSB', base_vol: 900, base_qty: 25, unit: 'g' },
                    { name: 'NaCl', base_vol: 900, base_qty: 15, unit: 'g' },
                    { name: 'Agua para análisis (base)', base_vol: 900, base_qty: 900, unit: 'ml' },
                    { name: 'Solución Stock', base_vol: 900, base_qty: 50, unit: 'ml' },
                    { name: 'Suero Fetal Bovino', base_vol: 900, base_qty: 50, unit: 'ml' }
                ],
                steps: [
                    'Disolver TSB y NaCl en el agua para análisis.',
                    'Esterilizar el medio base según el procedimiento estándar general.',
                    'Enfriar a 45-50°C, añadir la Solución Stock y el SFB asépticamente.',
                    'Mezclar y alicuotar.'
                ]
            },
            {
                name: 'Suero Fisiológico (Solución Salina 0.9%)',
                id: 'suero-fisiologico',
                purpose: 'Solución salina isotónica para diluciones.',
                storage: 'Temp. ambiente, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Cloruro de Sodio (NaCl)', base_vol: 1000, base_qty: 9, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver el NaCl en el agua para análisis.',
                    'Dispensar en recipientes finales.',
                    'Esterilizar según el procedimiento estándar general.'
                ]
            },
            {
                name: 'Caldo Tripticasa de Soya (TSB)',
                id: 'tsb-broth',
                purpose: 'Medio líquido de enriquecimiento general.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de TSB', base_vol: 1000, base_qty: 30, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver el polvo en el agua para análisis.',
                    'Verificar pH en 7.2 - 7.4.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar y alicuotar.'
                ]
            },
            {
                name: 'Caldo Tripticasa de Soya Sal (TSB/SAL)',
                id: 'tsb-sal-broth',
                purpose: 'Medio líquido para microorganismos halófilos.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de TSB', base_vol: 1000, base_qty: 30, unit: 'g' },
                    { name: 'Cloruro de Sodio (NaCl)', base_vol: 1000, base_qty: 10, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver ambos polvos en el agua para análisis.',
                    'Verificar pH en 7.2 - 7.4.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar y alicuotar.'
                ]
            },
            {
                name: 'Caldo Mueller Hinton II Ajustado con Cationes (MHCA)',
                id: 'mhca',
                purpose: 'Medio estándar para pruebas de sensibilidad.',
                storage: '2-8°C, hasta 90 días.',
                references: null,
                notes: [],
                ingredients: [
                    { name: 'Polvo de Caldo MHCA', base_vol: 1000, base_qty: 22, unit: 'g' },
                    { name: 'Agua para análisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }
                ],
                steps: [
                    'Disolver el polvo en el agua para análisis.',
                    'Calentar y hervir por 1 minuto.',
                    'Verificar pH en 7.3 ± 0.1.',
                    'Esterilizar según el procedimiento estándar general.',
                    'Enfriar y alicuotar.'
                ]
            },
            {
                name: 'Solución Stock (L-Cisteína/D-Glucosa)',
                id: 'solucion-stock-ifop',
                purpose: 'Suplemento estéril para Caldo IFOP PsM11.',
                storage: '2-8°C.',
                references: null,
                notes: ['Esta solución DEBE ser esterilizada por filtración (membrana de 0.22 µm). NUNCA autoclavar.', 'Realizar todo el procedimiento bajo Campana de Flujo Laminar.'],
                ingredients: [
                    { name: 'L-Cisteína HCl', vol1000: 'N/A', vol500: '10 g', vol250: 'N/A' },
                    { name: 'D-Glucosa', vol1000: 'N/A', vol500: '100 g', vol250: 'N/A' },
                    { name: 'Agua para análisis estéril', vol1000: 'N/A', vol500: 'c.s.p. 500 ml', vol250: 'N/A' }
                ],
                steps: [
                    'Pesar y añadir los solutos a una botella estéril.',
                    'Aforar a 500 ml con agua para análisis estéril.',
                    'Agitar suavemente hasta disolver.',
                    'Esterilizar por filtración.',
                    'Dispensar en alícuotas estériles.'
                ]
            }
        ];
        
        const selectElement = document.getElementById('media-select');
        const searchBox = document.getElementById('search-box');
        const displayElement = document.getElementById('procedure-display');
        const modal = document.getElementById('calculator-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const calculateBtn = document.getElementById('calculate-btn');
        const volumeInput = document.getElementById('volume-input');
        const calculatorResults = document.getElementById('calculator-results');

        let currentMediaForCalculator = null;

        function populateSelect(filter = '') {
            const filteredMedia = mediaDatabase.filter(media => media.name.toLowerCase().includes(filter.toLowerCase()));
            selectElement.innerHTML = '';
            filteredMedia.sort((a, b) => a.name.localeCompare(b.name));
            filteredMedia.forEach(media => {
                const option = document.createElement('option');
                option.value = media.id;
                option.textContent = media.name;
                selectElement.appendChild(option);
            });
            if (filteredMedia.length > 0) {
                 renderProcedure(selectElement.value);
            } else {
                 displayElement.innerHTML = '<p class="text-center text-gray-500">No se encontraron medios.</p>';
            }
        }
        
        function formatNumber(num) {
            return Number.isInteger(num) ? num : num.toFixed(2);
        }

        function renderProcedure(mediaId) {
            const media = mediaDatabase.find(m => m.id === mediaId);
            currentMediaForCalculator = media;
            if (!media) {
                displayElement.innerHTML = '<p>Procedimiento no encontrado.</p>';
                return;
            }

            let ingredientsTable = `
                <table class="w-full border-collapse my-4 text-sm md:text-base">
                    <thead>
                        <tr>
                            <th class="table-cell table-header">Componente</th>
                            <th class="table-cell table-header">Para 1000 ml</th>
                            <th class="table-cell table-header">Para 500 ml</th>
                            <th class="table-cell table-header">Para 250 ml</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            media.ingredients.forEach(ing => {
                const vol1000 = ing.vol1000 || `${formatNumber(ing.base_qty)} ${ing.unit}`;
                const vol500 = ing.vol500 || `${formatNumber(ing.base_qty * (500 / (ing.base_vol || 1000)))} ${ing.unit}`;
                const vol250 = ing.vol250 || `${formatNumber(ing.base_qty * (250 / (ing.base_vol || 1000)))} ${ing.unit}`;

                ingredientsTable += `
                    <tr>
                        <td class="table-cell font-semibold">${ing.name}</td>
                        <td class="table-cell">${vol1000}</td>
                        <td class="table-cell">${vol500}</td>
                        <td class="table-cell">${vol250}</td>
                    </tr>
                `;
            });
            ingredientsTable += '</tbody></table>';

            let stepsList = '<ol class="space-y-3 mt-4">';
            media.steps.forEach((step, index) => {
                stepsList += `
                    <li class="checklist-item" data-step="${index}">
                        <input type="checkbox" id="step-${index}" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <label for="step-${index}" class="text-gray-700 leading-relaxed">${step}</label>
                    </li>
                `;
            });
            stepsList += '</ol>';
            
            let notesHTML = '';
            if (media.notes && media.notes.length > 0) {
                let notesList = '<ul class="list-disc list-inside space-y-1 mt-2">';
                media.notes.forEach(note => {
                    notesList += `<li>${note}</li>`;
                });
                notesList += '</ul>';

                notesHTML = `
                    <div class="mt-6 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-r-lg">
                        <h4 class="font-bold flex items-center">
                            <span class="text-xl mr-2">⚠️</span>
                            Consideraciones Importantes
                        </h4>
                        ${notesList}
                    </div>
                `;
            }

            let referencesHTML = media.references ? `<div class="mt-4 pt-4 border-t border-gray-200">
                <h4 class="font-semibold text-gray-700">Referencias:</h4>
                <p class="text-sm text-gray-600 italic">${media.references}</p>
            </div>` : '';

            const procedureHTML = `
                <div class="animate-fade-in">
                    <h2 class="text-2xl md:text-3xl font-bold text-[#00428d]">${media.name}</h2>
                    <p class="text-gray-600 mt-2 mb-4">${media.purpose}</p>
                    
                    <div class="mt-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold mb-2 text-[#005cb8]">Ingredientes y Cantidades</h3>
                            <button id="open-calculator-btn" class="text-xl p-2 rounded-full hover:bg-gray-200 w-10 h-10 flex items-center justify-center"><i class="fa-solid fa-calculator"></i></button>
                        </div>
                        ${ingredientsTable}
                    </div>

                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 text-[#005cb8]">Procedimiento</h3>
                        ${stepsList}
                    </div>
                    
                    ${notesHTML}

                    <div class="mt-6 bg-sky-100 border-l-4 border-sky-500 text-sky-800 p-4 rounded-r-lg">
                        <h4 class="font-bold">Almacenamiento y Vida Útil</h4>
                        <p>${media.storage}</p>
                    </div>
                    ${referencesHTML}
                </div>
            `;

            displayElement.innerHTML = procedureHTML;
            document.getElementById('open-calculator-btn').addEventListener('click', openCalculator);
            
            document.querySelectorAll('.checklist-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (e.target !== checkbox) {
                         checkbox.checked = !checkbox.checked;
                    }
                    item.classList.toggle('completed', checkbox.checked);
                });
            });
        }
        
        function openCalculator() {
            volumeInput.value = '';
            calculatorResults.innerHTML = '';
            modal.classList.remove('hidden');
        }

        function closeCalculator() {
            modal.classList.add('hidden');
        }

        calculateBtn.addEventListener('click', () => {
            const targetVolume = parseFloat(volumeInput.value);
            if (!targetVolume || targetVolume <= 0 || !currentMediaForCalculator) {
                calculatorResults.innerHTML = '<p class="text-red-500">Por favor, ingrese un volumen válido.</p>';
                return;
            }

            let resultsHTML = `
                <h4 class="font-bold mt-4 mb-2">Resultados para ${targetVolume} ml:</h4>
                <ul class="list-disc list-inside space-y-1">
            `;

            currentMediaForCalculator.ingredients.forEach(ing => {
                const newQty = (targetVolume / (ing.base_vol || 1000)) * ing.base_qty;
                resultsHTML += `<li><strong>${ing.name}:</strong> ${formatNumber(newQty)} ${ing.unit}</li>`;
            });
            
            resultsHTML += '</ul>';
            calculatorResults.innerHTML = resultsHTML;
        });

        searchBox.addEventListener('input', (e) => {
            populateSelect(e.target.value);
        });

        selectElement.addEventListener('change', (e) => {
            renderProcedure(e.target.value);
        });
        
        closeModalBtn.addEventListener('click', closeCalculator);
        modal.addEventListener('click', (e) => {
            if(e.target === modal) {
                closeCalculator();
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            populateSelect();
        });

    </script>
</body>
</html>
