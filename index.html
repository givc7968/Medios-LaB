<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gu√≠a de Preparaci√≥n de Medios</title>
    
    <!-- PWA-specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gu√≠a de Medios">
    <!-- Self-Contained SVG Icon to prevent external loading issues -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%23005cb8'/%3E%3Ctext y='0.9em' font-size='90'%3Eüß™%3C/text%3E%3C/svg%3E">
    <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Gu√≠a de Medios&quot;,&quot;short_name&quot;:&quot;Gu√≠aMedios&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;scope&quot;:&quot;/&quot;,&quot;background_color&quot;:&quot;#f0f4f8&quot;,&quot;theme_color&quot;:&quot;#00428d&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%23005cb8'/%3E%3Ctext y='0.9em' font-size='90'%3Eüß™%3C/text%3E%3C/svg%3E&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},{&quot;src&quot;:&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%23005cb8'/%3E%3Ctext y='0.9em' font-size='90'%3Eüß™%3C/text%3E%3C/svg%3E&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    <meta name="theme-color" id="theme-color-meta" content="#00428d">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --header-dark: #00428d;
            --main-bg-dark: #f0f4f8;
            --card-bg-dark: #ffffff;
            --accent-color: #f97316;
            --accent-color-hover: #ea580c;

            --header-light: #ffffff;
            --main-bg-light: #f9fafb;
            --card-bg-light: #ffffff;
        }

        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            flex-direction: column;
            background-color: var(--main-bg-dark); /* Changed to match main content */
            transition: background-color 0.3s ease;
        }
        body.light-mode { background-color: var(--main-bg-light); }
        #app-container { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        header.app-header {
            padding-top: env(safe-area-inset-top);
            flex-shrink: 0;
            background-image: linear-gradient(to bottom, #0052a8, #00428d);
            color: #ffffff;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.light-mode header.app-header {
             background-color: var(--header-light);
             color: #1f2937;
             border-bottom: 1px solid #e5e7eb;
             background-image: none;
        }
        #controls-section {
            flex-shrink: 0;
            background-color: var(--header-dark);
            transition: background-color 0.3s ease;
        }
        body.light-mode #controls-section { background-color: var(--header-light); }
        main {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
        }
        
        main footer {
            text-align: center;
            padding-top: 1rem;
            padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); /* Safe area for home bar */
            color: #6b7280;
            font-size: 0.75rem;
        }

        /* Visual Improvements */
        .content-card {
            background-color: var(--card-bg-dark);
            color: #1f2937;
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
        }
        body.light-mode .content-card { background-color: var(--card-bg-light); }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }

        .interactive-btn { transition: transform 0.1s ease; }
        .interactive-btn:active { transform: scale(0.95); }

        .table-cell { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        .table-header { background-color: #005cb8; color: white; font-weight: bold; }
        body.light-mode .table-header { background-color: #f3f4f6; color: #374151; }
        
        .checklist-item { display: flex; align-items: center; padding: 10px 4px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background-color 0.2s; }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-item:hover { background-color: #f9fafb; }
        .checklist-item .checkbox-custom {
            width: 22px; height: 22px; border: 2px solid #9ca3af; border-radius: 6px;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease-in-out; flex-shrink: 0;
        }
        .checklist-item .checkbox-custom .fa-check { transform: scale(0); transition: all 0.2s ease-in-out; color: white; font-size: 14px; }
        .checklist-item.completed .checkbox-custom { background-color: #22c55e; border-color: #22c55e; }
        .checklist-item.completed .checkbox-custom .fa-check { transform: scale(1); }
        .checklist-item.completed label { text-decoration: line-through; color: #6b7280; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .accent-btn { background-color: var(--accent-color); }
        .accent-btn:hover { background-color: var(--accent-color-hover); }

        /* Tooltip for thermolabile info */
        .info-icon { position: relative; cursor: pointer; }
        .info-icon .tooltip {
            visibility: hidden; opacity: 0;
            width: 200px; background-color: #2d3748; color: #fff;
            text-align: center; border-radius: 6px; padding: 8px;
            position: absolute; z-index: 1; bottom: 125%; left: 50%;
            margin-left: -100px; transition: opacity 0.3s, visibility 0.3s;
        }
        .info-icon .tooltip.visible {
            visibility: visible;
            opacity: 1;
        }
        .info-icon .tooltip::after {
            content: ""; position: absolute; top: 100%; left: 50%;
            margin-left: -5px; border-width: 5px; border-style: solid;
            border-color: #2d3748 transparent transparent transparent;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header class="app-header p-4 shadow-lg z-10 flex justify-between items-center">
            <button id="theme-toggle-btn" class="interactive-btn text-xl p-2 rounded-full w-10 h-10 flex items-center justify-center">
                <i class="fas fa-sun"></i>
            </button>
            <h1 class="text-xl md:text-2xl font-bold text-center">Gu√≠a de Preparaci√≥n</h1>
            <button id="compendium-toggle-btn" class="interactive-btn text-xl p-2 rounded-full w-10 h-10 flex items-center justify-center">
                 <i class="fa-solid fa-book-open"></i>
            </button>
        </header>

        <div id="controls-section">
             </div>

        <main>
            <div id="procedure-view">
                </div>
            <div id="compendium-view" class="hidden">
                 </div>
            <footer>
                <p>Manual de Procedimientos v2.0</p>
            </footer>
        </main>
    </div>
    
    <div id="calculator-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Calculadora de Volumen</h3>
            <div class="mb-4">
                <label for="volume-input" class="block text-sm font-medium text-gray-700">Volumen deseado (ml):</label>
                <input type="number" id="volume-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)] sm:text-sm" placeholder="Ej: 650">
            </div>
            <button id="calculate-btn" class="w-full accent-btn text-white font-bold py-2 px-4 rounded-lg transition-colors">Calcular</button>
            <div id="calculator-results" class="mt-4 text-gray-800"></div>
            <button id="close-modal-btn" class="w-full mt-4 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Cerrar</button>
        </div>
    </div>

    <script>
        const mediaDatabase = [
            { name: '7.1 Agar Tripticasa de Soya (TSA)', id: 'tsa', purpose: 'Medio de cultivo general.', storage: '2-8¬∞C, 90 d√≠as.', ingredients: [{ name: 'Polvo de Agar TSA', brand: 'BD Bacto‚Ñ¢', base_vol: 1000, base_qty: 40, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Disolver el polvo en el agua para an√°lisis. Aplicar calor suave si es necesario.','Verificar que el pH est√© en el rango 7.2 - 7.4.','Esterilizar seg√∫n el procedimiento est√°ndar general (121¬∞C por 15 min).','Enfriar a 45-50¬∞C y dispensar en placas de Petri.'] },
            { name: '7.2 Agar Tripticasa de Soya Sal (TSA/SAL)', id: 'tsa-sal', purpose: 'Medio para pat√≥genos salinos.', storage: '2-8¬∞C, 90 d√≠as.', ingredients: [{ name: 'Polvo de Agar TSA', brand: 'BD Bacto‚Ñ¢', base_vol: 1000, base_qty: 40, unit: 'g' },{ name: 'NaCl', brand: 'Merck', base_vol: 1000, base_qty: 10, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Disolver los polvos en el agua para an√°lisis. Aplicar calor suave si es necesario.','Verificar pH en el rango 7.2 - 7.4.','Esterilizar seg√∫n el procedimiento est√°ndar general.','Enfriar a 45-50¬∞C y dispensar en placas de Petri.'] },
            { name: '7.3 Agar TYES', id: 'tyes', purpose: 'Crecimiento de Flavobacterium.', storage: '2-8¬∞C, 90 d√≠as.', ingredients: [{ name: 'Triptona', brand: 'BD', base_vol: 1000, base_qty: 4.0, unit: 'g' },{ name: 'Extracto de levadura', brand: 'BD', base_vol: 1000, base_qty: 0.4, unit: 'g' },{ name: 'CaCl‚ÇÇ¬∑2H‚ÇÇO', brand: 'Merck', base_vol: 1000, base_qty: 0.5, unit: 'g' },{ name: 'MgSO‚ÇÑ¬∑7H‚ÇÇO', brand: 'Merck', base_vol: 1000, base_qty: 0.5, unit: 'g' },{ name: 'Agar', brand: 'BD', base_vol: 1000, base_qty: 15, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Disolver los componentes en el agua para an√°lisis con agitaci√≥n y calor suave.','Verificar y ajustar pH a 7.2.','Esterilizar seg√∫n el procedimiento est√°ndar general.','Enfriar a 45-50¬∞C y dispensar en placas de Petri.'] },
            { name: '7.4 Agar MAOA (Anacker y Ordal Modificado)', id: 'maoa', purpose: 'Crecimiento de Flavobacterium.', storage: '2-8¬∞C, 90 d√≠as.', ingredients: [{ name: 'Triptona', brand: 'BD', base_vol: 1000, base_qty: 5.0, unit: 'g' },{ name: 'Extracto de levadura', brand: 'BD', base_vol: 1000, base_qty: 0.5, unit: 'g' },{ name: 'Acetato de Sodio', brand: 'Merck', base_vol: 1000, base_qty: 0.2, unit: 'g' },{ name: 'Extracto de carne', brand: 'BD', base_vol: 1000, base_qty: 0.2, unit: 'g' },{ name: 'Agar', brand: 'BD', base_vol: 1000, base_qty: 15, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Disolver los componentes en el agua para an√°lisis con agitaci√≥n y calor suave.','Verificar y ajustar pH a 7.2 - 7.4.','Esterilizar seg√∫n el procedimiento est√°ndar general.','Enfriar a 45-50¬∞C y dispensar en placas de Petri.'] },
            { name: '7.5 Agar Marino', id: 'agar-marino', purpose: 'Bacterias marinas heter√≥trofas.', storage: '2-8¬∞C, 90 d√≠as.', ingredients: [{ name: 'Polvo de Agar Marino', brand: 'BD Difco‚Ñ¢ 2216', base_vol: 1000, base_qty: 55.1, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Disolver el polvo en el agua para an√°lisis. Aplicar calor suave si es necesario.','Verificar que el pH est√© en el rango 7.6 ¬± 0.2.','Esterilizar seg√∫n el procedimiento est√°ndar general.','Enfriar a 45-50¬∞C y dispensar en placas.'] },
            { name: '7.6 Caldo Marino (Marine Broth 2216)', id: 'caldo-marino', purpose: 'Cultivo de bacterias marinas.', storage: '2-8¬∞C, 90 d√≠as.', ingredients: [{ name: 'Polvo de Caldo Marino', brand: 'BD Difco‚Ñ¢ 2216', base_vol: 1000, base_qty: 37.4, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Suspender el polvo en el agua para an√°lisis. Hervir por 1 minuto con agitaci√≥n.','Verificar que el pH est√© en el rango 7.6 ¬± 0.2.','Esterilizar seg√∫n el procedimiento est√°ndar general.','Enfriar y alicuotar si es necesario.'] },
            { name: '7.7 Agar Sabouraud Dextrosa', id: 'sabouraud', purpose: 'Aislamiento de hongos y levaduras.', storage: '2-8¬∞C, 90 d√≠as.', ingredients: [{ name: 'Polvo de Agar Sabouraud', brand: 'BD BBL‚Ñ¢', base_vol: 1000, base_qty: 65, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Disolver el polvo en el agua para an√°lisis. Aplicar calor suave si es necesario.','Verificar y ajustar pH a 5.6 ¬± 0.2.','Esterilizar seg√∫n el procedimiento est√°ndar general.','Enfriar a 45-50¬∞C y dispensar en placas.'] },
            { name: '7.8 Agar Papa Dextrosa (PDA)', id: 'pda', purpose: 'Cultivo de levaduras y mohos.', storage: '2-8¬∞C, 90 d√≠as.', notes: ['Puede acidificarse con √°cido tart√°rico est√©ril.'], ingredients: [{ name: 'Polvo de PDA', brand: 'BD Difco‚Ñ¢', base_vol: 1000, base_qty: 39, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Suspender el polvo en el agua. Hervir por 1 minuto con agitaci√≥n.','Verificar que el pH est√© en el rango 5.6 ¬± 0.2.','Esterilizar seg√∫n el procedimiento est√°ndar general.','Enfriar a 45-50¬∞C y dispensar en placas.'] },
            { name: '7.9 Agar P. salmonis', id: 'agar-p-salmonis', purpose: 'Crecimiento de Piscirickettsia salmonis.', storage: '2-8¬∞C, 30 d√≠as.', notes:['La sangre es termol√°bil.'], ingredients: [{ name: 'Agar Base Sangre', brand: 'BD BBL‚Ñ¢', base_vol: 1000, base_qty: 40, unit: 'g' },{ name: 'NaCl', brand: 'Merck', base_vol: 1000, base_qty: 5, unit: 'g' },{ name: 'L-Ciste√≠na', brand: 'Sigma', base_vol: 1000, base_qty: 1, unit: 'g' },{ name: 'NaOH 10N', brand: 'Merck', base_vol: 1000, base_qty: 200, unit: '¬µL' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 960, unit: 'ml' },{ name: 'Sangre desfibrinada', brand: 'Proveedor local', base_vol: 1000, base_qty: 40, unit: 'ml', thermolabile: true, add_note: 'A√±adir as√©pticamente al medio enfriado a 80¬∞C.' }], steps: ['Disolver los polvos en el agua para an√°lisis. Aplicar calor suave si es necesario.','A√±adir el NaOH estimado y verificar con pHmetro hasta alcanzar 6.7 ¬± 0.1.','Esterilizar el medio base seg√∫n el procedimiento est√°ndar general.','Enfriar a 80¬∞C y a√±adir as√©pticamente la sangre.','Mezclar suavemente y dispensar en placas.'] },
            { name: '7.10 Agar KDM-C', id: 'kdm-c', purpose: 'Selectivo para Renibacterium.', storage: '2-8¬∞C, 90 d√≠as.', ingredients: [{ name: 'Peptona', brand: 'BD', base_vol: 1000, base_qty: 10, unit: 'g' },{ name: 'Extracto de levadura', brand: 'BD', base_vol: 1000, base_qty: 0.5, unit: 'g' },{ name: 'Carb√≥n activado', brand: 'Sigma', base_vol: 1000, base_qty: 1, unit: 'g' },{ name: 'L-ciste√≠na', brand: 'Sigma', base_vol: 1000, base_qty: 1, unit: 'g' },{ name: 'NaOH 10N', brand: 'Merck', base_vol: 1000, base_qty: 600, unit: '¬µL' },{ name: 'Agar', brand: 'BD', base_vol: 1000, base_qty: 15, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' },{ name: 'Amphotericin B', brand: 'Sigma', base_vol: 1000, base_qty: 1, unit: 'ml', thermolabile: true, add_note: 'A√±adir as√©pticamente al medio enfriado a 45-50¬∞C.' }], steps: ['Disolver los componentes (excepto Amphotericin B) en agua. Aplicar calor suave.','A√±adir el NaOH y verificar que el pH est√© en 7.2 - 7.4.','Esterilizar el medio base seg√∫n el procedimiento est√°ndar general.','Enfriar a 45-50¬∞C y a√±adir as√©pticamente la Amphotericin B.','Mezclar y dispensar en placas.'] },
            { name: '7.11 Agar KDM-2', id: 'kdm2-agar', purpose: 'Enriquecido para Renibacterium.', storage: '2-8¬∞C, 30 d√≠as.', notes: ['El ajuste de pH 7.5 es CR√çTICO.'], ingredients: [{ name: 'Peptona', brand: 'BD', base_vol: 1000, base_qty: 10, unit: 'g' },{ name: 'Extracto de levadura', brand: 'BD', base_vol: 1000, base_qty: 0.5, unit: 'g' },{ name: 'L-Ciste√≠na', brand: 'Sigma', base_vol: 1000, base_qty: 1, unit: 'g' },{ name: 'NaOH 10N (estimado)', brand: 'Merck', base_vol: 1000, base_qty: 424, unit: '¬µL' },{ name: 'Agar', brand: 'BD', base_vol: 1000, base_qty: 15, unit: 'g' },{ name: 'Agua para an√°lisis (base)', base_vol: 1000, base_qty: 900, unit: 'ml' },{ name: 'Suero Fetal Bovino', brand: 'Gibco', base_vol: 1000, base_qty: 100, unit: 'ml', thermolabile: true, add_note: 'A√±adir as√©pticamente al medio enfriado a 45-50¬∞C.' }], steps: ['Disolver los componentes (excepto SFB) en agua. Aplicar calor suave.','A√±adir el NaOH estimado y verificar con pHmetro hasta alcanzar 7.5 ¬± 0.1.','Esterilizar el medio base seg√∫n el procedimiento est√°ndar general.','Enfriar a 45-50¬∞C y a√±adir as√©pticamente el Suero Fetal Bovino.','Mezclar y dispensar en placas.'] },
            { name: '7.12 Caldo KDM-2 L√≠quido', id: 'kdm2-broth', purpose: 'Cultivo de R. salmoninarum.', storage: '2-8¬∞C, 30 d√≠as.', notes: ['El ajuste de pH 7.5 es CR√çTICO.'], ingredients: [{ name: 'Peptona', brand: 'BD', base_vol: 1000, base_qty: 10, unit: 'g' },{ name: 'Extracto de levadura', brand: 'BD', base_vol: 1000, base_qty: 0.5, unit: 'g' },{ name: 'L-Ciste√≠na HCl', brand: 'Sigma', base_vol: 1000, base_qty: 0.5, unit: 'g' },{ name: 'NaOH 10N (estimado)', brand: 'Merck', base_vol: 1000, base_qty: 424, unit: '¬µL' },{ name: 'Agua para an√°lisis (base)', base_vol: 1000, base_qty: 900, unit: 'ml' },{ name: 'Suero Fetal Bovino', brand: 'Gibco', base_vol: 1000, base_qty: 100, unit: 'ml', thermolabile: true, add_note: 'A√±adir as√©pticamente al medio enfriado a 45-50¬∞C.' }], steps: ['Disolver los polvos en el agua para an√°lisis.','Ajuste de pH (Paso Cr√≠tico): Medir el pH inicial (aprox. 5.15). A√±adir lentamente el NaOH 10N estimado y ajustar hasta alcanzar 7.5 ¬± 0.1.','Esterilizar el medio base seg√∫n el procedimiento est√°ndar general.','Enfriar a 45-50¬∞C y a√±adir as√©pticamente el Suero Fetal Bovino.','Mezclar y alicuotar si es necesario.'] },
            { name: '7.13 Caldo IFOP PsM11', id: 'ifop-psm11', purpose: 'Medio para CIM de P. salmonis.', storage: '4¬∞C, m√°x. 10 d√≠as.', notes: ['Soluci√≥n Stock es termol√°bil.'], ingredients: [{ name: 'TSB', brand: 'BD BBL‚Ñ¢', base_vol: 1000, base_qty: 25, unit: 'g' },{ name: 'NaCl', brand: 'Merck', base_vol: 1000, base_qty: 15, unit: 'g' },{ name: 'Agua para an√°lisis (base)', base_vol: 1000, base_qty: 900, unit: 'ml' },{ name: 'Soluci√≥n Stock', brand: 'Preparaci√≥n propia', base_vol: 1000, base_qty: 50, unit: 'ml', thermolabile: true, add_note: 'A√±adir as√©pticamente al medio enfriado. Esterilizar por filtraci√≥n.' },{ name: 'Suero Fetal Bovino', brand: 'Gibco', base_vol: 1000, base_qty: 50, unit: 'ml', thermolabile: true, add_note: 'A√±adir as√©pticamente al medio enfriado a 45-50¬∞C.' }], steps: ['Disolver TSB y NaCl en el agua para an√°lisis.','Esterilizar el medio base seg√∫n el procedimiento est√°ndar general.','Enfriar a 45-50¬∞C y a√±adir as√©pticamente la Soluci√≥n Stock y el SFB.','Mezclar y alicuotar.'] },
            { name: '7.14 Suero Fisiol√≥gico (Soluci√≥n Salina 0.9%)', id: 'suero-fisiologico', purpose: 'Soluci√≥n salina isot√≥nica.', storage: 'Temp. ambiente, 90 d√≠as.', ingredients: [{ name: 'NaCl', brand: 'Merck', base_vol: 1000, base_qty: 9, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Disolver el NaCl en el agua para an√°lisis.','Dispensar en los recipientes finales (ej. tubos).','Esterilizar seg√∫n el procedimiento est√°ndar general.'] },
            { name: '7.15 Caldo Tripticasa de Soya (TSB)', id: 'tsb-broth', purpose: 'Enriquecimiento general.', storage: '2-8¬∞C, 90 d√≠as.', ingredients: [{ name: 'Polvo de TSB', brand: 'BD BBL‚Ñ¢', base_vol: 1000, base_qty: 30, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Disolver el polvo en el agua para an√°lisis.','Ajuste de pH: Verificar que el pH est√© en 7.2 - 7.4.','Esterilizar seg√∫n el procedimiento est√°ndar general.','Enfriar y alicuotar si es necesario.'] },
            { name: '7.16 Caldo Tripticasa de Soya Sal (TSB/SAL)', id: 'tsb-sal-broth', purpose: 'Enriquecimiento para hal√≥filos.', storage: '2-8¬∞C, 90 d√≠as.', ingredients: [{ name: 'Polvo de TSB', brand: 'BD BBL‚Ñ¢', base_vol: 1000, base_qty: 30, unit: 'g' },{ name: 'NaCl', brand: 'Merck', base_vol: 1000, base_qty: 10, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Disolver ambos polvos en el agua para an√°lisis.','Ajuste de pH: Verificar que el pH est√© en 7.2 - 7.4.','Esterilizar seg√∫n el procedimiento est√°ndar general.','Enfriar y alicuotar si es necesario.'] },
            { name: '7.17 Caldo Mueller Hinton II Cationes Ajustados (MHCA)', id: 'mhca', purpose: 'Pruebas de sensibilidad.', storage: '2-8¬∞C, 90 d√≠as.', ingredients: [{ name: 'Polvo de Caldo MHCA', brand: 'BD BBL‚Ñ¢', base_vol: 1000, base_qty: 22, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Disolver el polvo en el agua para an√°lisis.','Calentamiento: Calentar y hervir por 1 minuto.','Ajuste de pH: Verificar pH en 7.3 ¬± 0.1.','Esterilizaci√≥n: Autoclavar seg√∫n Secci√≥n 6.','Dispensado: Enfriar y alicuotar.'] },
            { name: '7.18 Caldo Mueller-Hinton Diluido (1:7) Suplementado con Iones Inorg√°nicos', id: 'mh-diluted', purpose: 'CMI en Tenacibaculum.', storage: '2-8¬∞C.', references: 'CLSI VET04-A2', ingredients: [{ name: 'Caldo MH en polvo', brand: 'BD BBL‚Ñ¢', base_vol: 1000, base_qty: 3.0, unit: 'g' },{ name: 'NaCl', brand: 'Merck', base_vol: 1000, base_qty: 21.43, unit: 'g' },{ name: 'MgSO‚ÇÑ¬∑7H‚ÇÇO', brand: 'Merck', base_vol: 1000, base_qty: 4.29, unit: 'g' },{ name: 'CaCl‚ÇÇ¬∑2H‚ÇÇO', brand: 'Merck', base_vol: 1000, base_qty: 0.86, unit: 'g' },{ name: 'KCl', brand: 'Merck', base_vol: 1000, base_qty: 0.86, unit: 'g' },{ name: 'Agua para an√°lisis', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Preparaci√≥n Directa: Disolver todos los componentes s√≥lidos directamente en el 80% del volumen final de agua.','Aforo: Transferir a un matraz aforado y completar el volumen final con agua. Homogeneizar.','Ajuste de pH: Verificar que el pH est√© en el rango 7.2 - 7.4.','Esterilizaci√≥n: Esterilizar en autoclave seg√∫n Secci√≥n 6.','Dispensado: Enfriar y alicuotar en recipientes est√©riles si es necesario.'] },
            { name: '7.19 Caldo Mueller Hinton Cationes Ajustados Diluido (4g/L)', id: 'mhca-diluted', purpose: 'CMI en Flavobacterium.', storage: '2-8¬∞C, 4 semanas.', references: 'CLSI VET04-A2', ingredients: [{ name: 'CAMHB en polvo', brand: 'BD BBL‚Ñ¢', base_vol: 1000, base_qty: 4.0, unit: 'g' },{ name: 'Agua Purificada', base_vol: 1000, base_qty: 1000, unit: 'ml' }], steps: ['Disolver los componentes en el agua para an√°lisis con agitaci√≥n y calor suave.','Ajuste de pH: Verificar que el pH est√© en el rango 7.2 - 7.4. Generalmente no se requiere ajuste.','Esterilizaci√≥n: Autoclavar seg√∫n Secci√≥n 6.','Dispensado: Enfriar a temperatura ambiente y dispensar as√©pticamente.'] },
            { name: '8.1 Soluci√≥n Stock de L-Ciste√≠na y D-Glucosa', id: 'solucion-stock-ifop', purpose: 'Suplemento para Caldo IFOP.', storage: '2-8¬∞C.', notes: ['Esterilizar por filtraci√≥n (0.22 ¬µm). NUNCA autoclavar.'], ingredients: [{ name: 'L-Ciste√≠na HCl', brand: 'Sigma', base_vol: 500, base_qty: 10, unit: 'g' },{ name: 'D-Glucosa', brand: 'Merck', base_vol: 500, base_qty: 100, unit: 'g' },{ name: 'Agua para an√°lisis est√©ril', base_vol: 500, base_qty: 500, unit: 'ml' }], steps: ['Pesar y a√±adir los solutos a una botella est√©ril.','Aforar a 500 ml con agua para an√°lisis est√©ril.','Agitar suavemente hasta disolver.','Esterilizar por filtraci√≥n.','Dispensar en al√≠cuotas est√©riles.'] }
        ];
        
        const procedureView = document.getElementById('procedure-view');
        const compendiumView = document.getElementById('compendium-view');
        const controlsSection = document.getElementById('controls-section');
        const compendiumToggleBtn = document.getElementById('compendium-toggle-btn');
        const appTitle = document.querySelector('header.app-header h1');
        
        const modal = document.getElementById('calculator-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const calculateBtn = document.getElementById('calculate-btn');
        const volumeInput = document.getElementById('volume-input');
        const calculatorResults = document.getElementById('calculator-results');
        const themeToggleButton = document.getElementById('theme-toggle-btn');
        const themeColorMeta = document.getElementById('theme-color-meta');

        let currentMediaForCalculator = null;
        let isCompendiumVisible = false;

        // --- TEMPLATES ---
        const procedureControlsTemplate = `
            <div class="p-4 pt-2 max-w-4xl mx-auto">
                <input type="search" id="search-box" placeholder="Buscar procedimiento..." class="w-full p-3 mb-4 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#4da3ff] focus:border-[#4da3ff] text-lg">
                <select id="media-select" class="w-full p-3 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#4da3ff] focus:border-[#4da3ff] text-lg"></select>
            </div>`;
        
        const compendiumControlsTemplate = `
            <div class="p-4 pt-2 max-w-4xl mx-auto">
                <input type="search" id="reagent-search-box" placeholder="Buscar reactivo..." class="w-full p-3 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#4da3ff] focus:border-[#4da3ff] text-lg">
            </div>`;

        // --- LOGIC ---
        function formatNumber(num) {
            return Number.isInteger(num) ? num : parseFloat(num.toFixed(3));
        }

        function populateSelect(filter = '') {
            const mediaSelect = document.getElementById('media-select');
            if (!mediaSelect) return;

            const filteredMedia = mediaDatabase.filter(media => media.name.toLowerCase().includes(filter.toLowerCase()));
            const currentSelection = mediaSelect.value;
            mediaSelect.innerHTML = '';
            
            const placeholder = document.createElement('option');
            placeholder.value = "";
            placeholder.textContent = "-- Seleccione un procedimiento --";
            placeholder.disabled = true;
            placeholder.selected = true;
            mediaSelect.appendChild(placeholder);

            filteredMedia.sort((a, b) => a.name.localeCompare(b.name));
            filteredMedia.forEach(media => {
                const option = document.createElement('option');
                option.value = media.id;
                option.textContent = media.name;
                mediaSelect.appendChild(option);
            });

            if (filteredMedia.some(m => m.id === currentSelection)) {
                mediaSelect.value = currentSelection;
            }
        }

        function renderProcedure(mediaId) {
            procedureView.classList.remove('fade-in');

            setTimeout(() => {
                const media = mediaDatabase.find(m => m.id === mediaId);
                currentMediaForCalculator = media;
                if (!media) {
                     procedureView.innerHTML = `
                        <div class="content-card text-center p-8 fade-in">
                            <h2 class="text-2xl font-bold text-[#00428d] mb-2">Bienvenido a la Gu√≠a de Medios</h2>
                            <p class="text-gray-600 mb-4">El prop√≥sito de esta aplicaci√≥n es servir como una gu√≠a digital e interactiva para la preparaci√≥n estandarizada de medios de cultivo, asegurando la calidad y consistencia para garantizar resultados confiables.</p>
                            <p class="text-gray-500">Seleccione un procedimiento del men√∫ superior para comenzar.</p>
                            <i class="fas fa-bacteria text-6xl text-gray-300 mt-6"></i>
                        </div>`;
                    return;
                }

                const createCard = (title, content, iconClass) => {
                    if (!content || (Array.isArray(content) && content.length === 0) || (typeof content === 'string' && content.trim() === '')) return '';
                    return `
                        <div class="content-card">
                            <h3 class="text-xl font-bold mb-3 text-[#005cb8] flex items-center">
                                <i class="fa-solid ${iconClass} w-6 text-center mr-3 text-lg"></i>
                                ${title}
                            </h3>
                            ${content}
                        </div>`;
                };

                const ingredientsTable = `
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse my-2 text-sm md:text-base">
                            <thead>
                                <tr>
                                    <th class="table-cell table-header">Componente</th>
                                    <th class="table-cell table-header text-right">Para 1000 ml</th>
                                    <th class="table-cell table-header text-right">Para 500 ml</th>
                                    <th class="table-cell table-header text-right">Para 250 ml</th>
                                </tr>
                            </thead>
                            <tbody>
                ${media.ingredients.map(ing => {
                    const getAmountForVolume = (targetVol) => {
                        if (media.id === 'solucion-stock-ifop' && ing.base_vol !== targetVol) return 'N/A';
                        const amount = (targetVol / ing.base_vol) * ing.base_qty;
                        return `${formatNumber(amount)} ${ing.unit}`;
                    };
                    const infoIcon = ing.thermolabile ? `
                        <span class="info-icon ml-2 text-blue-500">
                            <i class="fa-solid fa-circle-info"></i>
                            <span class="tooltip">${ing.add_note}</span>
                        </span>` : '';

                    return `
                        <tr>
                            <td class="table-cell font-semibold flex items-center">${ing.name} ${infoIcon}</td>
                            <td class="table-cell text-right">${getAmountForVolume(1000)}</td>
                            <td class="table-cell text-right">${getAmountForVolume(500)}</td>
                            <td class="table-cell text-right">${getAmountForVolume(250)}</td>
                        </tr>
                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>`;

                const stepsList = `<ol class="space-y-1 mt-2">${media.steps.map((step) => `
                    <li class="checklist-item">
                        <span class="checkbox-custom"><i class="fa-solid fa-check"></i></span>
                        <label class="text-gray-700 leading-relaxed ml-2">${step}</label>
                    </li>`).join('')}</ol>`;
                
                const notesList = (media.notes && media.notes.length > 0) 
                    ? `<ul class="list-disc list-inside space-y-1 mt-2">${media.notes.map(note => `<li>${note}</li>`).join('')}</ul>`
                    : '';
                
                const referencesHTML = media.references ? `<p class="text-sm text-gray-600 italic mt-2">${media.references}</p>` : '';

                const procedureHTML = `
                    <div class="content-card">
                        <div class="flex justify-between items-start">
                             <h2 class="text-2xl md:text-3xl font-bold text-[#00428d]">${media.name}</h2>
                             <button id="open-calculator-btn" class="interactive-btn text-white accent-btn rounded-full w-12 h-12 flex items-center justify-center text-2xl shadow-lg flex-shrink-0 ml-4"><i class="fa-solid fa-calculator"></i></button>
                        </div>
                        <p class="text-gray-600 mt-2 mb-4">${media.purpose}</p>
                    </div>
                    ${createCard('Ingredientes y Cantidades', ingredientsTable, 'fa-vials')}
                    ${createCard('Procedimiento', stepsList, 'fa-list-check')}
                    ${createCard('Consideraciones Importantes', notesList, 'fa-triangle-exclamation')}
                    ${createCard('Almacenamiento y Vida √ötil', `<p>${media.storage}</p>`, 'fa-box-archive')}
                    ${createCard('Referencias', referencesHTML, 'fa-book-bookmark')}
                `;

                procedureView.innerHTML = procedureHTML;
                procedureView.classList.add('fade-in');
                document.getElementById('open-calculator-btn').addEventListener('click', openCalculator);
                document.querySelectorAll('.checklist-item').forEach(item => {
                    item.addEventListener('click', () => item.classList.toggle('completed'));
                });
                // Add event listeners for new tooltips
                document.querySelectorAll('.info-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const tooltip = icon.querySelector('.tooltip');
                        // Hide other tooltips before showing the new one
                        document.querySelectorAll('.tooltip.visible').forEach(t => {
                            if (t !== tooltip) t.classList.remove('visible');
                        });
                        tooltip.classList.toggle('visible');
                    });
                });
            }, 50);
        }

        function renderCompendium(filter = '') {
            const reagents = {};
            mediaDatabase.forEach(media => {
                media.ingredients.forEach(ing => {
                    if (!reagents[ing.name]) {
                        reagents[ing.name] = {
                            brand: ing.brand || 'No especificado',
                            media: new Set()
                        };
                    }
                    reagents[ing.name].media.add(media.name.split(' ').slice(1).join(' '));
                });
            });

            let compendiumHTML = '';
            Object.keys(reagents).sort().forEach(reagentName => {
                if (reagentName.toLowerCase().includes(filter.toLowerCase())) {
                    const data = reagents[reagentName];
                    compendiumHTML += `
                        <div class="content-card">
                            <h3 class="text-xl font-bold text-[#005cb8]">${reagentName}</h3>
                            <p class="text-sm text-gray-500 font-semibold">Marca/Proveedor: ${data.brand}</p>
                            <div class="mt-2 pt-2 border-t">
                                <h4 class="font-semibold text-gray-700">Utilizado en:</h4>
                                <ul class="list-disc list-inside text-gray-600 text-sm mt-1">
                                    ${[...data.media].map(m => `<li>${m}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
            });
            compendiumView.innerHTML = compendiumHTML;
        }

        function toggleView(showCompendium) {
            isCompendiumVisible = showCompendium;
            if (showCompendium) {
                appTitle.textContent = 'Compendio de Reactivos';
                compendiumToggleBtn.innerHTML = '<i class="fa-solid fa-vial"></i>';
                procedureView.classList.add('hidden');
                compendiumView.classList.remove('hidden');
                controlsSection.innerHTML = compendiumControlsTemplate;
                renderCompendium();
                document.getElementById('reagent-search-box').addEventListener('input', (e) => renderCompendium(e.target.value));
            } else {
                appTitle.textContent = 'Gu√≠a de Preparaci√≥n';
                compendiumToggleBtn.innerHTML = '<i class="fa-solid fa-book-open"></i>';
                procedureView.classList.remove('hidden');
                compendiumView.classList.add('hidden');
                controlsSection.innerHTML = procedureControlsTemplate;
                const searchBox = document.getElementById('search-box');
                const mediaSelect = document.getElementById('media-select');
                populateSelect();
                searchBox.addEventListener('input', (e) => populateSelect(e.target.value));
                mediaSelect.addEventListener('change', (e) => renderProcedure(e.target.value));
            }
        }
        
        function openCalculator() { modal.classList.remove('hidden'); }
        function closeCalculator() { modal.classList.add('hidden'); }

        calculateBtn.addEventListener('click', () => {
            const targetVolume = parseFloat(volumeInput.value);
            if (!targetVolume || targetVolume <= 0 || !currentMediaForCalculator) {
                calculatorResults.innerHTML = '<p class="text-red-500">Por favor, ingrese un volumen v√°lido.</p>'; return;
            }
            let resultsHTML = `<h4 class="font-bold mt-4 mb-2">Resultados para ${targetVolume} ml:</h4><ul class="list-disc list-inside space-y-1">`;
            currentMediaForCalculator.ingredients.forEach(ing => {
                const newQty = (targetVolume / ing.base_vol) * ing.base_qty;
                resultsHTML += `<li><strong>${ing.name}:</strong> ${formatNumber(newQty)} ${ing.unit}</li>`;
            });
            resultsHTML += '</ul>';
            calculatorResults.innerHTML = resultsHTML;
        });
        
        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                themeToggleButton.innerHTML = '<i class="fas fa-moon"></i>';
                themeColorMeta.setAttribute('content', '#ffffff');
            } else {
                document.body.classList.remove('light-mode');
                themeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
                themeColorMeta.setAttribute('content', '#00428d');
            }
        }

        themeToggleButton.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('light-mode') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        compendiumToggleBtn.addEventListener('click', () => toggleView(!isCompendiumVisible));
        closeModalBtn.addEventListener('click', closeCalculator);
        modal.addEventListener('click', (e) => { if(e.target === modal) closeCalculator(); });
        
        // Global click listener to close tooltips
        document.addEventListener('click', () => {
            document.querySelectorAll('.tooltip.visible').forEach(t => t.classList.remove('visible'));
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            toggleView(false); // Start with procedure view
            renderProcedure(null); // Show welcome message on start
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
        });

    </script>
</body>
</html>
